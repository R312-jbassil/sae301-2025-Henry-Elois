---
import Layout from "../layouts/Layout.astro";

// Redirige si déjà connecté
if (Astro.locals.user) {
  return Astro.redirect("/");
}
---

<Layout title="Créer un compte - TaVue">
  <div class="flex items-center justify-center min-h-screen">
    <div class="card bg-base-100 shadow-xl p-8 w-full max-w-md border">
      <div class="flex flex-col items-center mb-4">
        <div class="flex gap-2 mb-2">
          <div
            class="w-10 h-10 bg-black rounded-full flex items-center justify-center"
          >
            <span class="text-white text-sm font-bold">Ta</span>
          </div>
          <div
            class="w-10 h-10 border-2 border-black rounded-full flex items-center justify-center"
          >
            <span class="text-black text-sm font-bold">Vue</span>
          </div>
        </div>
        <h1 class="text-2xl font-bold mb-1">Créer un compte</h1>
        <p class="text-gray-600 text-center text-sm">
          Rejoignez TaVue et créez vos lunettes sur mesure.
        </p>
      </div>
      <div class="w-full border-b mb-4"></div>

      <form id="signup-form" class="space-y-4">
        <input
          type="text"
          id="name"
          name="name"
          class="input input-bordered w-full"
          placeholder="Nom complet"
          required
        />

        <input
          type="email"
          id="email"
          name="email"
          class="input input-bordered w-full"
          placeholder="Adresse e-mail"
          required
        />

        <input
          type="password"
          id="password"
          name="password"
          class="input input-bordered w-full"
          placeholder="Mot de passe (min. 8 caractères)"
          minlength="8"
          required
        />

        <input
          type="password"
          id="passwordConfirm"
          name="passwordConfirm"
          class="input input-bordered w-full"
          placeholder="Confirmez le mot de passe"
          minlength="8"
          required
        />

        <button type="submit" class="btn btn-primary w-full">
          S'inscrire
        </button>

        <p class="text-sm text-center mt-2">
          Déjà un compte ?
          <a href="/login" class="link link-primary">Se connecter</a>
        </p>
      </form>
      <p id="status" class="mt-4 text-center"></p>
    </div>
  </div>

  <script>
    const form = document.getElementById("signup-form") as HTMLFormElement;
    const status = document.getElementById("status") as HTMLParagraphElement;

    if (form && status) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        status.textContent = "Création du compte...";
        status.className = "mt-4 text-center text-info";

        const formData = new FormData(form);
        const name = formData.get("name") as string;
        const email = formData.get("email") as string;
        const password = formData.get("password") as string;
        const passwordConfirm = formData.get("passwordConfirm") as string;

        // Validation côté client
        if (password !== passwordConfirm) {
          status.textContent = "❌ Les mots de passe ne correspondent pas !";
          status.className = "mt-4 text-center text-error";
          return;
        }

        if (password.length < 8) {
          status.textContent =
            "❌ Le mot de passe doit contenir au moins 8 caractères !";
          status.className = "mt-4 text-center text-error";
          return;
        }

        try {
          const res = await fetch("/api2/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password, passwordConfirm }),
          });

          const data = await res.json();

          if (res.ok && data.success) {
            status.textContent = "✅ Compte créé avec succès ! Redirection...";
            status.className = "mt-4 text-center text-success";
            setTimeout(() => {
              window.location.href = "/personnalisation";
            }, 1000);
          } else {
            status.textContent =
              "❌ " + (data.error || "Impossible de créer le compte");
            status.className = "mt-4 text-center text-error";
          }
        } catch (err) {
          console.error("Erreur signup:", err);
          status.textContent = "⚠️ Erreur réseau lors de l'inscription.";
          status.className = "mt-4 text-center text-error";
        }
      });
    }
  </script>
</Layout>
